{% extends "base.html" %}

{% block content %}
<div class="gallery-detail-container">
    <div class="gallery-detail-header mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-3" style="flex: 1; min-width: 0;">
                <a href="{{ url_for('main.gallery') }}" class="btn btn-outline-secondary flex-shrink-0" aria-label="Back">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <h2 class="mb-0 text-truncate" title="{{ post.title }}">{{ post.title|safe }}</h2>
            </div>
            
            {% if current_user.is_authenticated and current_user.is_admin() %}
            <div class="d-flex gap-2 flex-shrink-0">
                <button type="button" class="btn btn-sm btn-outline-primary text-nowrap" data-bs-toggle="modal" data-bs-target="#editPostModal" data-post-id="{{ post.id }}">
                    <i class="bi bi-pencil"></i> {% if current_lang == 'en' %}Edit{% else %}수정{% endif %}
                </button>
                <form action="{{ url_for('main.delete_post', post_id=post.id) }}" method="POST" class="d-inline" onsubmit="return confirm('{% if current_lang == 'en' %}Are you sure you want to delete this post?{% else %}정말 이 글을 삭제하시겠습니까?{% endif %}');">
                    <button type="submit" class="btn btn-sm btn-outline-danger text-nowrap">
                        <i class="bi bi-trash"></i> {% if current_lang == 'en' %}Delete{% else %}삭제{% endif %}
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="gallery-detail-info">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-2">{{ post.title|safe }}</h5>
                        <p class="card-text text-muted mb-0">
                            <small>
                                {% if current_lang == 'en' %}
                                    By {% if post.author.is_admin() %}IU DOTCOM{% else %}{{ post.author.name }}{% endif %} on {{ post.created_at.strftime('%B %d, %Y') }}
                                {% else %}
                                    {% if post.author.is_admin() %}아이유닷컴{% else %}{{ post.author.name }}{% endif %} · {{ post.created_at.strftime('%Y년 %m월 %d일') }}
                                {% endif %}
                            </small>
                        </p>
                    </div>
                    {% if current_user.is_authenticated and current_user.is_admin() %}
                    <!-- 상단으로 이동시킴 -->
                    {% endif %}
                </div>
                {% if post.content %}
                <div class="gallery-detail-content">
                    {{ post.content|trim|safe }}
                </div>
                {% endif %}

                <!-- 이미지 캐러셀 (본문 하단에 배치) -->
                {% if post.images|length > 0 %}
                <div class="gallery-detail-images mt-4">
                    {% for img in post.images %}
                    <img src="{{ url_for('main.get_post_image', image_id=img.id) }}"
                         class="d-block w-auto mw-100 mx-auto rounded mb-3"
                         alt="{{ post.title }}"
                         style="max-height: 80vh; object-fit: contain;">
                    {% endfor %}
                </div>
                {% elif post.has_image_data() or post.image_url %}
                <!-- 단일 이미지 (PostImage가 없을 경우 기존 방식) -->
                <div class="gallery-detail-images mt-4">
                    {% set image_url = post.get_image_url() %}
                    {% if image_url %}
                        {% if image_url.startswith('/image/') %}
                            {% set image_url = image_url + '?w=1500' %}
                        {% endif %}
                        <img src="{{ image_url }}" class="d-block w-auto mw-100 mx-auto rounded" alt="{{ post.title }}">
                    {% endif %}
                </div>
                {% endif %}
                
                {# 원본 다운로드 버튼 #}
                {% if post.has_image_data() or post.image_url %}
                <div class="mt-3 pt-3 border-top">
                    <a href="{{ url_for('main.download_original_image', post_id=post.id) }}" 
                       class="btn btn-outline-primary" 
                       download>
                        <i class="bi bi-download me-2"></i>
                        {% if current_lang == 'en' %}Download Original Image{% else %}원본 다운로드{% endif %}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 이전/다음 네비게이션 -->
    <div class="gallery-detail-navigation mt-4">
        <div class="row g-3">
            <div class="col-md-6">
                {% if prev_post %}
                <a href="{{ url_for('main.gallery_detail', post_id=prev_post.id) }}" class="card text-decoration-none h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-chevron-left me-2"></i>
                            <div>
                                <small class="text-muted d-block">{% if current_lang == 'en' %}Previous{% else %}이전{% endif %}</small>
                                <strong>{{ prev_post.title }}</strong>
                            </div>
                        </div>
                    </div>
                </a>
                {% else %}
                <div class="card text-muted h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-chevron-left me-2"></i>
                            <div>
                                <small class="d-block">{% if current_lang == 'en' %}Previous{% else %}이전{% endif %}</small>
                                <strong>{% if current_lang == 'en' %}No more posts{% else %}더 이상 없습니다{% endif %}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="col-md-6">
                {% if next_post %}
                <a href="{{ url_for('main.gallery_detail', post_id=next_post.id) }}" class="card text-decoration-none h-100 text-end">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-end">
                            <div>
                                <small class="text-muted d-block">{% if current_lang == 'en' %}Next{% else %}다음{% endif %}</small>
                                <strong>{{ next_post.title }}</strong>
                            </div>
                            <i class="bi bi-chevron-right ms-2"></i>
                        </div>
                    </div>
                </a>
                {% else %}
                <div class="card text-muted h-100 text-end">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-end">
                            <div>
                                <small class="d-block">{% if current_lang == 'en' %}Next{% else %}다음{% endif %}</small>
                                <strong>{% if current_lang == 'en' %}No more posts{% else %}더 이상 없습니다{% endif %}</strong>
                            </div>
                            <i class="bi bi-chevron-right ms-2"></i>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
.gallery-detail-container {
    max-width: 1280px;
    margin: 0 auto;
    padding-top: 2rem; /* 상단 메뉴와 제목 사이 여백 추가 */
}

.gallery-detail-image {
    max-width: 100%;
    width: auto; /* 100% 강제 제거하여 원본 비율 유지 */
    height: auto; /* 높이는 비율에 맞게 자동 조절 */
    max-height: none; /* 높이 제한 제거 */
    object-fit: contain;
    border-radius: 4px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: block;
    margin: 0 auto;
}

.gallery-detail-image-wrapper {
    text-align: center;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem; /* 패딩을 다시 추가하여 이미지를 card-body보다 작게 만듦 */
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.gallery-detail-placeholder {
    text-align: center;
    padding: 4rem 2rem;
}

.gallery-detail-info {
    margin-top: 2rem;
}

.gallery-detail-content {
    margin-top: 1rem;
    line-height: 1.6;
}

/* 본문 내 이미지도 최대 1280px까지만, 반응형으로 표시 */
.gallery-detail-content img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 1rem auto;
}

.gallery-detail-navigation .card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.gallery-detail-navigation .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

@media (max-width: 768px) {
    .gallery-detail-image-wrapper {
        padding: 1rem;
        min-height: 300px;
    }
    
    .gallery-detail-image {
        max-height: 60vh;
    }
    
    .gallery-detail-header h2 {
        font-size: 1.25rem;
    }
}
</style>
{% endblock %}
{% endblock %}

